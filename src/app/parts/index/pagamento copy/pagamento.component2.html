send(form: NgForm) {
    console.log('TESTE')
    console.log('telefones', this.telefones, this.endereco, this.objeto, this.clienteModel);
    this.clienteModel.phones = this.telefones;
    this.clienteModel.adress = this.endereco;

    // Posta o cliente
    lastValueFrom(this.vindiService.postCliente(this.clienteModel)).then((clientePostado) => {
      const id = clientePostado.customer.id;

      console.log('Cliente postado:', id);
      this.assinaturaModel.customer_id = id;

      this.perfilModel.registry_code = clientePostado.customer.registry_code
      
      console.log('cpf,',this.perfilModel.registry_code, clientePostado, clientePostado.customer.registry_code)
      // Todo o código que depende de idCliente deve estar dentro deste bloco then
      console.log('objeto final cliente', this.idCliente, clientePostado);
      console.log('objeto final', this.clienteModel, this.clienteModel.adress, this.assinaturaModel);
      console.log('objeto assinatura final', this.assinaturaModel, this.perfilModel);

      if (this.perfilModel.card_expiration.length === 4) {
        // Remove todos os caracteres não numéricos
        const onlyNumbers = this.perfilModel.card_expiration.replace(/\D/g, '');
        // Formata a string para "00/00"
        const expiration = this.perfilModel.card_expiration.trim();
        this.perfilModel.card_expiration = `${expiration.slice(0, 2)}/${expiration.slice(2)}`;
        console.log('validade', this.perfilModel.card_expiration);
      }

      


      const perfil_Pagamento: any = {
        holder_name: this.perfilModel.holder_name,
        registry_code: this.perfilModel.registry_code,
        card_expiration: this.perfilModel.card_expiration,
        card_number: this.perfilModel.card_number,
        card_cvv: this.perfilModel.card_cvv,
        payment_method_code: this.perfilModel.payment_method_code,
        payment_company_code: this.perfilModel.payment_company_code,



      }

  
      this.assinaturaModel.payment_method_code = this.perfilModel.payment_method_code
      this.assinaturaModel.payment_profile = perfil_Pagamento;



      // const plano = this.plans
      // this.assinaturaModel.product_items[0].product_id = clientePostado


      interface Produto {
        id: number;
        // outras propriedades do produto
      }

      // Supondo que this.plans seja um array do tipo Produto
      const planoEncontrado = this.plans.find((produto: Produto) => produto.id === this.assinaturaModel.plan_id);


      if (planoEncontrado) {
        if (!this.assinaturaModel.product_items) {
          this.assinaturaModel.product_items = [];
        }

        const produto: ProdutosModel = new ProdutosModel();
        produto.product_id = planoEncontrado.plan_items[0].product.id;

        const teste: any = {
          product_id: planoEncontrado.plan_items[0].product.id
        }


        this.assinaturaModel.product_items.push(teste);

        console.log('objeto finallllll', this.assinaturaModel);

      }


      // const planoEncontrado = this.plans.find((produto: ProdutosModel) => produto.product_id === this.assinaturaModel.plan_id);






















      else {
        console.log('Nenhum plano encontrado com o ID correspondente.');
      }

      console.log('objeto assinatura final atualizado', this.assinaturaModel, this.perfilModel, planoEncontrado,);

      // this.assinaturaModel.payment_method_code[0].holder_name = this.perfilModel.holder_name

      lastValueFrom(this.vindiService.postAssinatura(this.assinaturaModel)).then((assinaturaPostada) => {
        const id = assinaturaPostada.subscription.customer.id
        console.log(assinaturaPostada, assinaturaPostada.subscription.id)
        const plano = assinaturaPostada.subscription.plan.id
        // const metodo = assinaturaPostada.subscription.payment_method.code
        const produto = assinaturaPostada.subscription.product_items[0].product.id
        const preco = assinaturaPostada.subscription.product_items[0].pricing_schema.price
        const valorSemPontos = preco.replace(/\./g, '');
        console.log('preco', preco, valorSemPontos)
        const produtoModel = new ProdutoModel();
        produtoModel.product_id = produto;

        const produtos: any = {
          product_id: produto,
          amount: valorSemPontos,

        };

        this.faturaModel.bill_items.push(produtos);

        this.faturaModel.customer_id = id
        this.faturaModel.plan_id = plano
        // this.faturaModel.due_at = metodo
        // this.faturaModel.payment_method_code = metodo
        this.faturaModel.billing_at = this.dataFormatadaTestes
        this.faturaModel.due_at = this.dataFormatadaTestes



        // if (this.assinaturaModel.payment_method_code=='credit_card') {
        //   this.cartaoModel.payment_method_code = this.faturaModel.payment_method_code
        //   lastValueFrom(this.vindiService.postCartao(this.cartaoModel)).then((res => {
        //     return console.log(res, "corpo", this.cartaoModel)
        //   }))
        // }





        // lastValueFrom(this.vindiService.postFatura(this.faturaModel)).then((res => {
        //   return console.log(res, "corpo", this.faturaModel)
        // }))

        console.log('id', id, assinaturaPostada, this.faturaModel, produtoModel, this.cartaoModel, this.clienteModel)
     
      })
    });
  }